# TODO:
# - List all topics
# - Attempt to subscribe to a non-existent topic and verify that it fails gracefully
# - Attempt to subscribe to a topic with invalid parameters (e.g. missing cert/key files when encryption is enabled) and verify that it fails gracefully
# - Attempt to subscribe to a topic with valid parameters and verify that it succeeds and receives messages published to the topic
# - Attempt to publish messages to a topic and verify that they are received by subscribers
# - Attempt more than one subscriber to the same topic and verify both subscribers receive the messages
# - Attempt more than one subscriber in the same consumer group to the same topic and verify that messages are load balanced between them (i.e. each message is only received by one of the subscribers in the group)
# - Attempt to publish messages to multiple topics and verify that they are received by the appropriate subscribers based on the topics they are subscribed to
# - Attempt to publish messages with encryption enabled and verify that they are received and can be decrypted by subscribers with the correct cert/key files, and that subscribers without the correct cert/key files cannot decrypt the messages
# - Verify latency of various sizes of messages
# - Verify throughput of various sizes of messages and various numbers of subscribers and publishers
name: pubsub-broker-integration-tests
labels:
  - docker-image
  - integration
dependencies:
  - artie-api-server: docker-image
  - artie-cli: docker-image
  - artie-service-broker: docker-image
  - test-sensor-service: docker-image
  - artie-pubsub-broker: docker-image
type: test
steps:
  - job: docker-compose-test-suite
    compose-fname: compose.pubsub.yaml
    compose-docker-image-variables:
      - ARTIE_PUBSUB_BROKER_TEST_IMAGE:
          dependency:
            name: docker-image
            producing-task: artie-pubsub-broker
      - ARTIE_API_SERVER_TEST_IMAGE:
          dependency:
            name: docker-image
            producing-task: artie-api-server
      - ARTIE_SERVICE_BROKER_TEST_IMAGE:
          dependency:
            name: docker-image
            producing-task: artie-service-broker
      - TEST_SENSOR_SERVICE_TEST_IMAGE:
          dependency:
            name: docker-image
            producing-task: test-sensor-service
    cli-image:
      dependency:
        name: docker-image
        producing-task: artie-cli
    steps:
      - test-name: list-topics
        cmd-to-run-in-cli: "artie-cli service list-topics"
        expected-outputs:
          - what: "TODO"
            where: artie-api-server
